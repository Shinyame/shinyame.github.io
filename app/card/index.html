<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>Swiss Tournament Calculator</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<link rel="manifest" href="manifest.json">
<link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
<link href="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/css/materialize.min.css" rel="stylesheet">

<style>
:root {
  --bg:#f5f5f5; --card:#fff; --text:#000;
}
.dark {
  --bg:#121212; --card:#1e1e1e; --text:#fff;
}
body {
  background:var(--bg);
  color:var(--text);
  font-size:20px;
}
.main {
  min-height:100vh;
  display:flex;
  justify-content:center;
  align-items:center;
}
.card-panel {
  max-width:720px;
  width:100%;
  border-radius:18px;
  padding:32px;
  background:var(--card);
}
.section-label {
  font-weight:bold;
  margin-top:24px;
}
.input-field {
  max-width:320px;
  margin:0 auto;
}
.result {
  margin-top:24px;
  padding:20px;
  border-radius:14px;
  background:rgba(33,150,243,.15);
}
.csp-box {
  margin-top:16px;
  padding:18px;
  border-radius:14px;
  background:rgba(76,175,80,.2);
}
</style>
</head>

<body>
<div class="main">
<div class="card-panel z-depth-2 center-align">

<h4>試合回数計算</h4>

<div class="section-label">参加人数</div>
<div class="input-field">
  <input type="number" id="players">
  <label>未入力: 32</label>
</div>

<div class="section-label">試合制限時間（分）</div>
<div class="input-field">
  <input type="number" id="time">
  <label>未入力: 25</label>
</div>

<div class="section-label">休憩時間（1Rあたり・分）</div>
<div class="input-field">
  <input type="number" id="break">
  <label>未入力: 0</label>
</div>

<div class="section-label">大会種別</div>

<p><label>
<input name="csp_mode" type="radio" value="none" checked>
<span>ジムバトル等</span>
</label>
<label>
<input name="csp_mode" type="radio" value="trainer">
<span>トレーナーズリーグ</span>
</label>
<label>
<input name="csp_mode" type="radio" value="city">
<span>シティリーグ</span>
</label></p>

<p class="section-label">
<label>
<input type="checkbox" id="doubleLose">
<span>引き分け＝両負けとして扱う</span>
</label>
</p>

<div class="switch">
<label>
Light
<input type="checkbox" id="dark">
<span class="lever"></span>
Dark
</label>
</div>

<div style="margin-top:30px">
<button class="btn-large blue" onclick="calc()">計算</button>
</div>

<div id="result" class="result" style="display:none"></div>

</div>
</div>

<script>
const qs=id=>document.getElementById(id)

function nextHour(d){
  d=new Date(d)
  if(d.getMinutes()>0)d.setHours(d.getHours()+1)
  d.setMinutes(0,0,0)
  return d
}
const fmt=d=>d.toTimeString().slice(0,5)

function getMode(){
  return document.querySelector('input[name="csp_mode"]:checked').value
}

function calc(){
  const p = Number(qs("players").value)||32
  const t = Number(qs("time").value)||25
  const b = Number(qs("break").value)||0
  const mode = getMode()
  const doubleLose = qs("doubleLose").checked

  const maxRounds = Math.ceil(Math.log2(p))
  const minRounds = doubleLose ? maxRounds : Math.max(1, maxRounds-1)

  const start = nextHour(new Date())
  const endMin = new Date(start.getTime()+(minRounds*t+(minRounds-1)*b)*60000)
  const endMax = new Date(start.getTime()+(maxRounds*t+(maxRounds-1)*b)*60000)

  let html=`
    <p><b>ラウンド数：</b>${minRounds}～${maxRounds}</p>
    <p><b>開始：</b>${fmt(start)}</p>
    <p><b>終了目安：</b>${fmt(endMin)}～${fmt(endMax)}</p>
  `

  if(mode==="trainer") html+=cspTrainer(p,maxRounds)
  if(mode==="city") html+=cspCity(p,maxRounds)
  if(mode==="none") html+=`<p class="grey-text">CSP付与なし</p>`

  qs("result").innerHTML=html
  qs("result").style.display="block"
  saveParams()
}

function cspTrainer(p,r){
  const t=[
    ["1位",15,0],["2位",12,1],["3-4位",10,1],
    ["5-8位",8,2],["9-16位",6,3],["17-32位",5,3]
  ]
  let h="<div class='csp-box'><b>トレーナーズリーグ CSP</b>"
  t.forEach(e=>{
    if(p>=Math.pow(2,e[2]+1)){
      h+=`<p>${e[0]} : ${e[1]} CSP（${r-e[2]}勝）</p>`
    }
  })
  return h+"</div>"
}

function cspCity(p,r){
  return `
  <div class="csp-box">
    <b>シティリーグ CSP（目安）</b>
    <p>1位 : 50 CSP</p>
    <p>2位 : 45 CSP</p>
    <p>TOP4 : 40 CSP</p>
    <p>TOP8 : 30 CSP</p>
  </div>`
}

function saveParams(){
  const p=new URLSearchParams({
    players:qs("players").value,
    time:qs("time").value,
    break:qs("break").value,
    mode:getMode(),
    dl:qs("doubleLose").checked?1:0
  })
  history.replaceState(null,"","?"+p)
}

function loadParams(){
  const p=new URLSearchParams(location.search)
  if(p.get("players"))qs("players").value=p.get("players")
  if(p.get("time"))qs("time").value=p.get("time")
  if(p.get("break"))qs("break").value=p.get("break")
  if(p.get("dl")==="1")qs("doubleLose").checked=true
  const m=p.get("mode")
  if(m)document.querySelector(`input[value="${m}"]`).checked=true
}

qs("dark").onchange=()=>document.body.classList.toggle("dark")
loadParams()

if('serviceWorker' in navigator){
  navigator.serviceWorker.register('sw.js')
}
</script>
</body>
</html>
